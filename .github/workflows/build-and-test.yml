name: Build and Test

on:
  pull_request:
  push:
    branches:
      - 'main'
      - 'devel/**'
      - 'copilot/**'
  workflow_dispatch:

jobs:
  build:
    if: github.event.pull_request.draft == false
    name: Build-${{ matrix.cfg.name }}
    runs-on: ubuntu-latest
    container: ghcr.io/neomutt/ubuntu

    strategy:
      # Limit jobs to one at a time so that ccache really helps later builds
      max-parallel: 1
      matrix:
        cfg:
          - name: default
            options:
          - name: disabled
            options: --disable-nls --disable-pgp --disable-smime --ssl --gsasl
          - name: everything
            options: --autocrypt --bdb --fmemopen --gdbm --gnutls --gpgme --gss --kyotocabinet --lmdb --lua --lz4 --notmuch --pcre2 --qdbm --rocksdb --sasl --tdb --tokyocabinet --with-lock=fcntl --zlib --zstd

    steps:
    - name: Get number of CPU cores
      uses: SimenB/github-actions-cpu-cores@v2
      id: cpu-cores

    - name: Checkout Code
      uses: actions/checkout@v6

    - name: Checkout Test Files
      uses: actions/checkout@v6
      with:
        repository: neomutt/neomutt-test-files
        path: test-files

    - name: Set Up Test Files
      run: |
        cd test-files
        ./setup.sh

    - name: Compilation Cache
      uses: hendrikmuhs/ccache-action@v1

    - name: Configure NeoMutt
      run: |
        mkdir build-${{ matrix.cfg.name }}
        cd build-${{ matrix.cfg.name }}
        ../configure --full-doc ${{ matrix.cfg.options }}

    - name: Build NeoMutt
      run: |
        cd build-${{ matrix.cfg.name }}
        make -j ${{steps.cpu-cores.outputs.count}} neomutt

    - name: NeoMutt Version
      run: |
        cd build-${{ matrix.cfg.name }}
        ./neomutt -v
        ./neomutt -h all

    - name: Test Docs
      run: |
        cd build-${{ matrix.cfg.name }}
        make validate-docs

    - name: Build Tests
      run: |
        cd build-${{ matrix.cfg.name }}
        make -j ${{steps.cpu-cores.outputs.count}} test/neomutt-test

    - name: Run Tests
      run: |
        cd build-${{ matrix.cfg.name }}
        export NEOMUTT_TEST_DIR=$GITHUB_WORKSPACE/test-files
        make test

    - name: Install NeoMutt
      run: |
        cd build-${{ matrix.cfg.name }}
        make DESTDIR=$HOME/neo-install install
        if [ ! -d "$HOME/neo-install" ] || [ -z "$(find "$HOME/neo-install" -type f)" ]; then
          echo "Error: install directory is empty or does not exist"
          exit 1
        fi

    - name: Uninstall NeoMutt
      run: |
        cd build-${{ matrix.cfg.name }}
        make DESTDIR=$HOME/neo-install uninstall

    - name: Check Uninstall
      run: |
        REMAINING=$(find "$HOME/neo-install" -type f 2>/dev/null | wc -l)
        if [ "$REMAINING" -ne 0 ]; then
          echo "Error: $REMAINING file(s) left after uninstall:"
          find "$HOME/neo-install" -type f
          exit 1
        fi

